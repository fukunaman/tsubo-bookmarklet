(()=>{const e="tsubo-shared-style";if(!document.getElementById(e)){const t=document.createElement("style");t.id=e,t.textContent=".tb{display:block;margin-top:4px;padding:2px 6px;border-radius:4px;font-weight:600;font-size:.82em;line-height:1.4;background:rgba(255,165,0,.16);color:#b45309}.tb-s{background:rgba(59,130,246,.18);color:#1d4ed8}.tb-a{background:rgba(244,114,182,.2);color:#be185d}",document.head.appendChild(t)}const t=3.305785,r=e=>e?e.replace(/\s+/g," ").trim():"",n=e=>{if(!e)return null;const t=e.replace(/\s+/g,"");let r=0;const n=t.match(/([\d.,]+)億/);n&&(r+=1e8*parseFloat(n[1].replace(/,/g,"")));const o=t.match(/([\d.,]+)万/);if(o&&(r+=1e4*parseFloat(o[1].replace(/,/g,""))),!n&&!o){const e=t.replace(/[^\d]/g,"");e&&(r+=parseInt(e,10))}return r||null},o=e=>{if(!e)return null;const r=e.replace(/㎡/g,"m2").replace(/m²/g,"m2");let n=null;const o=r.match(/([\d.,]+)m2/i);o&&(n=parseFloat(o[1].replace(/,/g,"")));let l=null;const a=r.match(/([\d.,]+)\s*坪/);return a&&(l=parseFloat(a[1].replace(/,/g,""))),!l&&n&&(l=n/t),l&&!n&&(n=l*t),l?{sqm:n,tsubo:l}:null},l=(e,t,n)=>{for(const o of e){if(!r(o.textContent).includes(t))continue;let e=n(o);if(e)return{element:e,text:r(e.textContent)}}return null},a=(e,t)=>{if(!e)return null;const n=Array.isArray(t)?t:[t];for(const t of n){const r=l(e.querySelectorAll("td.category"),t,e=>{let t=e.nextElementSibling;for(;t&&"TD"===t.tagName&&!t.classList.contains("value");)t=t.nextElementSibling;return t});if(r)return r}for(const t of n){const r=l(e.querySelectorAll("dt"),t,e=>{let t=e.nextElementSibling;for(;t&&"DD"!==t.tagName;)t=t.nextElementSibling;return t});if(r)return r}for(const t of n){const r=l(e.querySelectorAll("th"),t,e=>{let t=e.nextElementSibling;for(;t&&"TD"!==t.tagName;)t=t.nextElementSibling;return t});if(r)return r}for(const t of n)for(const n of e.querySelectorAll("span,strong,div,p,dd,td,li")){const e=r(n.textContent);if(e&&e.includes(t))return{element:n,text:e}}return null},c=(e,t,r,n)=>{if(!e)return;let o=e;if(n&&e.closest){const t=e.closest(n);t&&(o=t)}if(o.querySelector&&o.querySelector(":scope > .tb"))return;if(o.style){o.style.whiteSpace="normal";"inline"===getComputedStyle(o).display&&(o.style.display="inline-block")}const l=document.createElement("div");l.className=r,l.textContent=(t>=100?t.toFixed(0):t.toFixed(1))+"万円/坪",o.appendChild(l)},s=({items:e,priceLabels:t,areaLabels:l,className:s,containerSelector:u,fallbackMap:i})=>{if(!e.length)return!1;let p=!1;return e.forEach(e=>{if(e.querySelector(".tb"))return;const d=e.querySelector(".tb-host")||e;let b=a(e,t),f=a(e,l);const m=e.querySelector(".bukken-cassette__kakaku"),y=e.querySelector(".bukken-cassette__menseki");!b&&m&&(b={element:m,text:r(m.textContent)}),!f&&y&&(f={element:y,text:r(y.textContent)});let k=n(b&&b.text),S=o(f&&f.text);if((!k||!S)&&i){const t=e.querySelector("input[id]")?.id||e.querySelector("[data-bukken-no]")?.getAttribute("data-bukken-no");if(t&&i.has(t)){const e=i.get(t);!k&&e.price&&(k=e.price),!S&&e.area&&(S=e.area)}}if(!k||!S)return;const g=k/S.tsubo/1e4,q=b&&b.element||f&&f.element||d,x=q.closest('.property-price, .property-info__price, [class*="price"], .tb-host')||q;x&&x.querySelector(".tb")||(c(q,g,s,u),p=!0)}),p},u=({priceNodes:e,areaRoot:t,area:l,className:s,fallbackPrice:u})=>{if(!e.length)return!1;let i=l;if(!i){const e=a(t,["専有面積","面積"]);i=o(e&&e.text)}if(!i)return!1;let p=!1;return e.forEach(e=>{if(e.querySelector(".tb"))return;const t=n(r(e.textContent))||u;if(!t)return;const o=t/i.tsubo/1e4;e.style&&(e.style.whiteSpace="normal","inline"===getComputedStyle(e).display&&(e.style.display="inline-block")),c(e,o,s,null),p=!0}),p},i=new Map;let p=null,d=null;const b=document.querySelector("#serverApp-state");if(b)try{const e=JSON.parse(b.textContent||"{}"),r=Object.keys(e).find(e=>e.includes("/bukken/list/"));if(r&&e[r]&&e[r].body){const t=JSON.parse(e[r].body).data?.bukkenData?.bukkenList;Array.isArray(t)&&t.forEach(e=>{const t=e?.bukkenNo;if(!t)return;const r=n(e?.kakaku?e.kakaku+"万円":null);let l=null;e?.areaInfo&&(l=o(e.areaInfo.tsubo||e.areaInfo.area)),i.set(t,{price:r,area:l})})}const l=Object.keys(e).find(e=>e.includes("property-detail-ryutsu"));if(l&&e[l]&&e[l].body){const r=JSON.parse(e[l].body).data,n=r?.propertyData?.areaInfo,o=r?.propertyData?.contract?.price?.price;if(n)if(n.tsubo){const e=parseFloat(n.tsubo.replace(/[^\d.]/g,""));Number.isNaN(e)||(p={tsubo:e,sqm:n.area&&parseFloat(n.area.replace(/[^\d.]/g,""))||e*t})}else if(n.area){const e=parseFloat(n.area.replace(/[^\d.]/g,""));Number.isNaN(e)||(p={sqm:e,tsubo:e/t})}if(o){const e=Number(o);Number.isNaN(e)||(d=e)}}}catch(e){console.warn("athome state parse failed",e)}s({items:[...document.querySelectorAll("li.item.list-tpl, li.item.smartphone-tpl, [component-bukken-list-item], athome-csite-sp-part-bukken-card-ryutsu-sell-living")],priceLabels:["価格"],areaLabels:["専有面積","面積"],className:"tb",containerSelector:"td.value,dd",fallbackMap:i}),s({items:[...document.querySelectorAll("#js-bukkenList .property_unit, .bukken-cassette__body")],priceLabels:["販売価格","価格"],areaLabels:["専有面積","面積"],className:"tb tb-s",containerSelector:"dd,td.value,.dottable-value,.property_unit-info,.bukken-cassette__kakaku,.bukken-cassette__menseki",fallbackMap:i});const f=[...document.querySelectorAll(".card-box")];f.length&&f.forEach(e=>{if(e.querySelector(".tb"))return;const t=e.querySelector(".property-price"),l=[...e.querySelectorAll(".property-detail-table__block")].find(e=>{const t=e.querySelector("strong");return t&&r(t.textContent).includes("専有面積")}),a=l&&l.textContent;let s=n(t&&t.textContent),u=o(a);if((!s||!u)&&i.size){const t=e.querySelector("input[id]")?.id||e.querySelector("[data-bukken-no]")?.getAttribute("data-bukken-no");if(t&&i.has(t)){const e=i.get(t);!s&&e.price&&(s=e.price),!u&&e.area&&(u=e.area)}}s&&u&&t&&c(t,s/u.tsubo/1e4,"tb tb-a",null)}),u({priceNodes:[...document.querySelectorAll("span.price-area")],areaRoot:document,className:"tb"});const m=[document.querySelector(".futureInfo"),document.querySelector(".detail-sum-table"),document.querySelector(".bukken-detail__table"),document.querySelector("[component-page__basic-info-table]"),document];let y=null;for(const e of m){if(!e)continue;const t=a(e,["専有面積","面積"]);if(t&&o(t.text)){y=e;break}}let k=null;const S=document.querySelector(".futureInfo_menseki_disp");if(k=o(S&&S.textContent),!k&&y){const e=a(y,["専有面積","面積"]);k=o(e&&e.text)}if(!k){const e=a(document,["専有面積"]);k=o(e&&e.text)}if(p&&(k=p),k){if(u({priceNodes:[...new Set([...document.querySelectorAll("p.mt7.b"),...document.querySelectorAll(".bukken-detail__price"),...document.querySelectorAll(".bukken-detail__price-value"),...document.querySelectorAll(".futureInfo_list.futureInfo_kakaku"),...document.querySelectorAll(".futureInfo .card-price"),...document.querySelectorAll("[component-property-info-header] .card-price")])],areaRoot:y||document,area:k,className:"tb tb-s",fallbackPrice:d}),d&&k.tsubo){const e=d/k.tsubo/1e4,t=[...new Set([...document.querySelectorAll('.property-detail-top-area .card-price, .property-info__price, .property-detail-top-area [class*="price"], .property-summary__list .rent, .main-contents__box .card-price, p.price-main')])];let r=!1;for(const n of t)if(n){if(n.querySelector(".tb")){r=!0;break}if(c(n,e,"tb tb-a",null),n.querySelector(".tb")){r=!0;break}}if(!r){const t=document.querySelector(".property-detail-top-area")||document.body,r=document.createElement("div");r.style.marginTop="8px",t.insertBefore(r,t.firstChild),c(r,e,"tb tb-a",null)}}}})();