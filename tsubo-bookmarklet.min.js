(()=>{const e="tsubo-shared-style";if(!document.getElementById(e)){const t=document.createElement("style");t.id=e,t.textContent=".tb{display:block;margin-top:4px;padding:2px 6px;border-radius:4px;font-weight:600;font-size:.82em;line-height:1.4;background:rgba(255,165,0,.16);color:#b45309}.tb-s{background:rgba(59,130,246,.18);color:#1d4ed8}.tb-a{background:rgba(244,114,182,.2);color:#be185d}.tb-rehouse{font-size:1.1em;padding:4px 8px;font-weight:700;background:rgba(34,197,94,.2);color:#166534}",document.head.appendChild(t)}const t=3.305785,r=e=>e?e.replace(/\s+/g," ").trim():"",o=e=>{if(!e)return null;const t=e.replace(/\s+/g,"");let r=0;const o=t.match(/([\d.,]+)億/);o&&(r+=1e8*parseFloat(o[1].replace(/,/g,"")));const n=t.match(/([\d.,]+)万/);if(n&&(r+=1e4*parseFloat(n[1].replace(/,/g,""))),!o&&!n){const e=t.replace(/[^\d]/g,"");e&&(r+=parseInt(e,10))}return location.pathname.includes("/library/")&&e.includes("万")&&console.log("[tsubo-debug] Price parsing:",e,"->",r),r||null},n=e=>{if(!e)return null;const r=e.replace(/㎡/g,"m2").replace(/m²/g,"m2");let o=null;const n=r.match(/([\d.,]+)m2/i);n&&(o=parseFloat(n[1].replace(/,/g,"")));let l=null;const a=r.match(/([\d.,]+)\s*坪/);return a&&(l=parseFloat(a[1].replace(/,/g,""))),!l&&o&&(l=o/t),l&&!o&&(o=l*t),l?{sqm:o,tsubo:l}:null},l=(e,t,o)=>{for(const n of e){if(!r(n.textContent).includes(t))continue;let e=o(n);if(e)return{element:e,text:r(e.textContent)}}return null},a=(e,t)=>{if(!e)return null;const o=Array.isArray(t)?t:[t];for(const t of o){const r=l(e.querySelectorAll("td.category"),t,e=>{let t=e.nextElementSibling;for(;t&&"TD"===t.tagName&&!t.classList.contains("value");)t=t.nextElementSibling;return t});if(r)return r}for(const t of o){const r=l(e.querySelectorAll("dt"),t,e=>{let t=e.nextElementSibling;for(;t&&"DD"!==t.tagName;)t=t.nextElementSibling;return t});if(r)return r}for(const t of o){const r=l(e.querySelectorAll("th"),t,e=>{let t=e.nextElementSibling;for(;t&&"TD"!==t.tagName;)t=t.nextElementSibling;return t});if(r)return r}for(const t of o)for(const o of e.querySelectorAll("span,strong,div,p,dd,td,li")){const e=r(o.textContent);if(e&&e.includes(t))return{element:o,text:e}}return null},c=(e,t,r,o)=>{if(!e)return;let n=e;if(o&&e.closest){const t=e.closest(o);t&&(n=t)}if(n.querySelector&&n.querySelector(":scope > .tb"))return;if(n.style){n.style.whiteSpace="normal";"inline"===getComputedStyle(n).display&&(n.style.display="inline-block")}const l=document.createElement("div");l.className=r,l.textContent=(t>=100?t.toFixed(0):t.toFixed(1))+"万円/坪",n.appendChild(l)},s=/(?:^|\.)athome\.co\.jp$/.test(location.hostname),i=s?document.querySelector("athome-csite-pc-property-detail-ryutsu-sell-living, athome-csite-sp-property-detail-ryutsu-sell-living"):null,u=!!(s?document.querySelector("athome-csite-pc-property-list-sell-living, athome-csite-sp-property-list-sell-living"):null)&&!i,p="sumusite.sekisuihouse.co.jp"===location.hostname,d=p&&!!document.querySelector(".estateInfo_detail"),b=/(?:^|\.)rehouse\.co\.jp$/.test(location.hostname),f=b&&/\/buy\/mansion\/bkdetail\//.test(location.pathname),m=/(?:^|\.)suumo\.jp$/.test(location.hostname)&&/\/library\//.test(location.pathname),y=({items:e,priceLabels:t,areaLabels:l,className:s,containerSelector:i,fallbackMap:p})=>{if(u&&"tb"===s)return!1;if(!e.length)return!1;let d=!1;return e.forEach(e=>{if("1"===e.dataset.tbBadgeInjected)return;if(e.querySelector(".tb"))return;const u=e.querySelector(".tb-host")||e;let b=a(e,t),f=a(e,l);const m=e.querySelector(".bukken-cassette__kakaku"),y=e.querySelector(".bukken-cassette__menseki");!b&&m&&(b={element:m,text:r(m.textContent)}),!f&&y&&(f={element:y,text:r(y.textContent)});let g=o(b&&b.text),k=n(f&&f.text);if((!g||!k)&&p){const t=e.querySelector("input[id]")?.id||e.querySelector("[data-bukken-no]")?.getAttribute("data-bukken-no");if(t&&p.has(t)){const e=p.get(t);!g&&e.price&&(g=e.price),!k&&e.area&&(k=e.area)}}if(!g||!k)return;const h=g/k.tsubo/1e4,S=b&&b.element||f&&f.element||u,x=S.closest('.property-price, .property-info__price, [class*="price"], .tb-host')||S;x&&x.querySelector(".tb")||(c(S,h,s,i),e.dataset.tbBadgeInjected="1",d=!0)}),d},g=e=>{const t=[];return e.forEach(e=>{e&&document.querySelectorAll(e).forEach(e=>t.push(e))}),[...new Set(t)]},k=({priceNodes:e,areaRoot:t,area:l,className:s,fallbackPrice:i})=>{if(!e.length)return!1;let u=l;if(!u){const e=a(t,["専有面積","面積"]);u=n(e&&e.text)}if(!u)return!1;let p=!1;return e.forEach(e=>{if(e.querySelector(".tb"))return;const t=o(r(e.textContent))||i;if(!t)return;const n=t/u.tsubo/1e4;e.style&&(e.style.whiteSpace="normal","inline"===getComputedStyle(e).display&&(e.style.display="inline-block")),c(e,n,s,null),p=!0}),p},h=new Map;let S=null,x=null;const q=document.querySelector("#serverApp-state");if(q)try{const e=JSON.parse(q.textContent||"{}"),r=Object.keys(e).find(e=>e.includes("/bukken/list/"));if(r&&e[r]&&e[r].body){const t=JSON.parse(e[r].body).data?.bukkenData?.bukkenList;Array.isArray(t)&&t.forEach(e=>{const t=e?.bukkenNo;if(!t)return;const r=o(e?.kakaku?e.kakaku+"万円":null);let l=null;e?.areaInfo&&(l=n(e.areaInfo.tsubo||e.areaInfo.area)),h.set(t,{price:r,area:l})})}const l=Object.keys(e).find(e=>e.includes("property-detail-ryutsu"));if(l&&e[l]&&e[l].body){const r=JSON.parse(e[l].body).data,o=r?.propertyData?.areaInfo,n=r?.propertyData?.contract?.price?.price;if(o)if(o.tsubo){const e=parseFloat(o.tsubo.replace(/[^\d.]/g,""));Number.isNaN(e)||(S={tsubo:e,sqm:o.area&&parseFloat(o.area.replace(/[^\d.]/g,""))||e*t})}else if(o.area){const e=parseFloat(o.area.replace(/[^\d.]/g,""));Number.isNaN(e)||(S={sqm:e,tsubo:e/t})}if(n){const e=Number(n);Number.isNaN(e)||(x=e)}}}catch(e){console.warn("athome state parse failed",e)}y({items:[...document.querySelectorAll("li.item.list-tpl, li.item.smartphone-tpl, [component-bukken-list-item], athome-csite-sp-part-bukken-card-ryutsu-sell-living")],priceLabels:["価格"],areaLabels:["専有面積","面積"],className:"tb",containerSelector:"td.value,dd",fallbackMap:h}),y({items:[...document.querySelectorAll("#js-bukkenList .property_unit, .bukken-cassette__body")],priceLabels:["販売価格","価格"],areaLabels:["専有面積","面積"],className:"tb tb-s",containerSelector:"dd,td.value,.dottable-value,.property_unit-info,.bukken-cassette__kakaku,.bukken-cassette__menseki",fallbackMap:h});const _=[...document.querySelectorAll(".card-box")];if(_.length&&_.forEach(e=>{if("1"===e.dataset.tbBadgeInjected)return;if(e.querySelector(".tb"))return;const t=e.querySelector(".property-price"),l=[...e.querySelectorAll(".property-detail-table__block")].find(e=>{const t=e.querySelector("strong");return t&&r(t.textContent).includes("専有面積")}),a=l&&l.textContent;let s=o(t&&t.textContent),i=n(a);if((!s||!i)&&h.size){const t=e.querySelector("input[id]")?.id||e.querySelector("[data-bukken-no]")?.getAttribute("data-bukken-no");if(t&&h.has(t)){const e=h.get(t);!s&&e.price&&(s=e.price),!i&&e.area&&(i=e.area)}}s&&i&&t&&(c(t,s/i.tsubo/1e4,"tb tb-a",null),e.dataset.tbBadgeInjected="1")}),p){[...document.querySelectorAll(".estateBlock_list > li")].forEach(e=>{if("1"===e.dataset.tbBadgeInjected)return;if(!e.querySelector(".estate"))return;if(e.querySelector(".tb"))return void(e.dataset.tbBadgeInjected="1");const t=e.querySelector(".estate dl dd"),r=o(t&&t.textContent),l=[...e.querySelectorAll(".estate ul li")].find(e=>/[㎡m²坪]/.test(e.textContent||"")),a=n(l&&l.textContent);if(!r||!a)return;c(t||l||e,r/a.tsubo/1e4,"tb tb-s",null),e.dataset.tbBadgeInjected="1"})}if(m){console.log("[tsubo-debug] Processing SUUMO library page");const e=[...document.querySelectorAll("table tr, .property-row, .listing-row")];console.log("[tsubo-debug] Found rows:",e.length),e.forEach((e,t)=>{if("1"===e.dataset.tbBadgeInjected)return;if(e.querySelector(".tb"))return;const l=[...e.querySelectorAll("td, .cell, .data-cell")];if(l.length<2)return;let a=null,s=null,i="",u="";for(const e of l){const t=r(e.textContent);a||!/[0-9,]+万円/.test(t)&&!/[0-9,]+億/.test(t)||t.includes("賃料")||t.includes("月")||t.includes("円/月")||(a=e,i=t),!s&&/[0-9.]+㎡|[0-9.]+平米|[0-9.]+m[2²]/.test(t)&&(s=e,u=t)}if(console.log(`[tsubo-debug] Row ${t}: price="${i}", area="${u}"`),a&&s){const r=o(i),l=n(u);if(console.log(`[tsubo-debug] Row ${t} parsed: price=${r}, area=${l?.tsubo}`),r&&l&&l.tsubo>0){const o=r/l.tsubo/1e4;console.log(`[tsubo-debug] Row ${t} tsubo price: ${o.toFixed(1)}万円/坪`),c(a,o,"tb",null),e.dataset.tbBadgeInjected="1"}}})}if(b){const e=[...document.querySelectorAll("*")];let t=null,l=null;for(const o of e){const e=r(o.textContent);if(!t&&/[0-9]+(,?[0-9]+)*万円/.test(e)&&e.length<50&&(t={element:o,text:e}),!l&&/[0-9.]+㎡.*坪/.test(e)&&e.length<50&&(l={element:o,text:e}),t&&l)break}if(t&&l){const e=o(t.text),r=n(l.text);if(e&&r){const o=e/r.tsubo/1e4,n=t.element;n.querySelector(".tb")||c(n,o,"tb tb-rehouse",null)}}}if(s?!!i:p?d:!b||f){const e=["span.price-area"];s&&e.push("p.price-main"),p&&e.push(".estateInfo_detail .priceArea"),b&&e.push(".text-price-regular",".property-overview__price",".price-main",".price-section .price-value"),k({priceNodes:g(e),areaRoot:document,className:b?"tb tb-rehouse":"tb"});const t=s?document.querySelector(".property-summary__list .rent"):null;if(!x&&t){const e=o(r(t.textContent));e&&(x=e)}const l=[document.querySelector(".futureInfo"),document.querySelector(".detail-sum-table"),document.querySelector(".property-summary__list"),document.querySelector(".bukken-detail__table"),document.querySelector("[component-page__basic-info-table]"),document];let i=null;for(const e of l){if(!e)continue;const t=a(e,["専有面積","面積"]);if(t&&n(t.text)){i=e;break}}let u=null;const d=document.querySelector(".futureInfo_menseki_disp");if(u=n(d&&d.textContent),!u&&i){const e=a(i,["専有面積","面積"]);u=n(e&&e.text)}if(!u){const e=a(document,["専有面積"]);u=n(e&&e.text)}if(S&&(u=S),u){const e=["p.mt7.b",".bukken-detail__price",".bukken-detail__price-value",".futureInfo_list.futureInfo_kakaku",".futureInfo .card-price","[component-property-info-header] .card-price"];s&&e.push(".property-summary__list .rent","p.price-main"),p&&e.push(".estateInfo_detail .priceArea"),b&&e.push(".text-price-regular",".property-overview__price",".price-main",".price-section .price-value");if(k({priceNodes:g(e),areaRoot:i||document,area:u,className:b?"tb tb-rehouse":"tb tb-s",fallbackPrice:x}),s&&x&&u.tsubo){const e=x/u.tsubo/1e4,t=[".property-detail-top-area .card-price",".property-info__price",'.property-detail-top-area [class*="price"]',".main-contents__box .card-price"];t.unshift("p.price-main");const r=g(t);let o=!1;for(const t of r)if(t){if(t.querySelector(".tb")){o=!0;break}if(c(t,e,"tb tb-a",null),t.querySelector(".tb")){o=!0;break}}if(!o){const t=document.querySelector(".property-detail-top-area")||document.body,r=document.createElement("div");r.style.marginTop="8px",t.insertBefore(r,t.firstChild),c(r,e,"tb tb-a",null)}}}}})();